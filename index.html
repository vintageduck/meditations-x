<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marston Aurelius (Diagnostic)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        body { background: #1a1a1a; color: #e0e0e0; font-family: 'Playfair Display', serif; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        
        /* DIAGNOSTIC CONSOLE */
        #console {
            position: fixed; top: 0; left: 0; width: 100%; height: 40vh;
            background: rgba(0,0,0,0.9); color: #00ff00; font-family: monospace;
            font-size: 12px; padding: 10px; box-sizing: border-box;
            overflow-y: auto; z-index: 9999; border-bottom: 2px solid #00ff00;
            display: block; /* Visible by default for debugging */
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .error { color: #ff3333; font-weight: bold; }
        .success { color: #33ff33; }

        /* Normal App UI (Pushed down) */
        .app-layer { margin-top: 42vh; width: 100%; max-width: 500px; text-align: center; }
        h1 { font-family: 'Cinzel', serif; color: #8c7b75; letter-spacing: 2px; font-size: 1rem; }
        
        .card {
            background: #262626; margin: 20px auto; padding: 40px 20px;
            border-radius: 4px; border: 1px solid #444; width: 80%; min-height: 200px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .btn {
            background: none; border: 1px solid #e0e0e0; color: #e0e0e0;
            padding: 10px 20px; border-radius: 30px; font-family: 'Lato'; text-transform: uppercase;
            cursor: pointer; margin-top: 20px;
        }
    </style>
</head>
<body>

    <!-- THE MECHANIC'S CONSOLE -->
    <div id="console">
        <div class="log-entry">System: Initializing Diagnostic Mode...</div>
    </div>

    <div class="app-layer">
        <h1>Marston Aurelius</h1>
        <div class="card" id="card-display">
            <div id="status-text">Waiting for connection...</div>
        </div>
        <button class="btn" onclick="runDiagnostics()">Run Connection Test</button>
    </div>

    <script>
        // --- 1. PASTE URL HERE ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyeAgXo2SCcJOToWgbM2O3qdhsxz67NrMotSWjDWbEJafKJ7tLSMm7siu0t278bPqxe/exec"; 
        // -------------------------

        // Logger Function
        function log(msg, type = 'normal') {
            const consoleDiv = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const time = new Date().toLocaleTimeString();
            entry.innerText = `[${time}] ${msg}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Global Error Trap ( catches syntax errors )
        window.onerror = function(message, source, lineno, colno, error) {
            log(`CRITICAL JS ERROR: ${message} at line ${lineno}`, 'error');
            return false;
        };

        async function runDiagnostics() {
            log("--- STARTING TEST ---");
            const status = document.getElementById('status-text');
            status.innerText = "Testing...";

            // Check 1: URL Format
            if (API_URL.includes("YOUR_GOOGLE")) {
                log("FAIL: You forgot to paste the Google Script URL in the code.", 'error');
                status.innerText = "Error: No URL";
                return;
            }
            log(`URL Check: Looks valid (${API_URL.substring(0, 30)}...)`);

            // Check 2: Network Fetch
            try {
                log("Network: Attempting to contact Google...", 'normal');
                
                // We add a cache buster to prevent iOS caching old errors
                const cacheBuster = API_URL + "?t=" + new Date().getTime();
                
                const response = await fetch(cacheBuster, {
                    method: "GET",
                    headers: { "Content-Type": "text/plain" } // Simple header
                });

                log(`Network: Response received. Status: ${response.status}`);

                if (!response.ok) {
                    log(`FAIL: Server returned error ${response.status}`, 'error');
                    throw new Error(`HTTP Error ${response.status}`);
                }

                // Check 3: Data Parsing
                const textData = await response.text();
                log(`Data: Raw text received (${textData.length} chars)`);
                
                // Try parsing JSON
                try {
                    const jsonData = JSON.parse(textData);
                    log(`JSON: Parsed successfully. Found ${jsonData.length} items.`, 'success');
                    
                    if (jsonData.length > 0) {
                        status.innerText = jsonData[0].body || "Data found but no body text.";
                        log("SUCCESS: System is operational.", 'success');
                        log("First item title: " + (jsonData[0].title || "Untitled"));
                    } else {
                        status.innerText = "Connected, but Sheet is empty.";
                        log("WARN: Connected, but returned 0 items.", 'error');
                    }

                } catch (jsonErr) {
                    log("FAIL: Could not parse JSON. Google likely returned an HTML login page.", 'error');
                    log("Preview of data: " + textData.substring(0, 100), 'error');
                    status.innerText = "Data Error (See Console)";
                }

            } catch (e) {
                log(`FAIL: Network Error - ${e.message}`, 'error');
                if (e.message.includes("Failed to fetch")) {
                    log("HINT: This usually means a CORS issue or the URL is incomplete.", 'error');
                }
                status.innerText = "Connection Failed";
            }
        }

        // Auto-run on load
        setTimeout(runDiagnostics, 1000);

    </script>
</body>
</html>
```

---

### Step 2: What the Errors Mean

When you open this page, look at the Green/Red text box at the top.

* **Error: "Unexpected token < in JSON..."**
    * **Meaning:** The app connected, but Google sent back a Login Page (HTML) instead of your data.
    * **Fix:** In Google Script > Deploy > Manage Deployments, verify "Who has access" is set to **"Anyone"**. If it says "Anyone with Google Account", it will fail.

* **Error: "Failed to fetch"**
    * **Meaning:** The browser blocked the request entirely.
    * **Fix:** Usually means the URL is wrong (e.g., ends in `/edit` instead of `/exec`) or you pasted it without quotation marks.

* **Error: "Constraint not satisfied"**
    * **Meaning:** The spreadsheet logic crashed (e.g., reading a column that doesn't exist).
    * **Fix:** Ensure you added the **Private**, **Sealed**, and **Deleted** columns (Columns E, F, G) in your spreadsheet.

### Step 3: The "Safe" Google Script
Just to be 100% sure the brain isn't the problem, here is a simplified script that is impossible to crash. It forces a default value if a column is missing.

1.  Paste this into your Script Editor.
2.  **Deploy > New Version**. (Crucial).

```javascript
function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
  const rows = sheet.getDataRange().getValues();
  const output = [];

  // Start at row 1 to skip headers
  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    // Simple check: does the row have text in column C (Body)?
    if (row[2]) {
      output.push({
        date: row[0] || new Date(),
        title: row[1] || "",
        body: row[2],
        tags: row[3] || "",
        isPrivate: row[4] === true,
        isSealed: row[5] === true,
        isDeleted: row[6] === true
      });
    }
  }

  return ContentService.createTextOutput(JSON.stringify(output))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  // Simple success response for now to test connection
  return ContentService.createTextOutput(JSON.stringify({result: "success"}))
    .setMimeType(ContentService.MimeType.JSON);
}
